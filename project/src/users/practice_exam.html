<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>√în T·∫≠p B·∫£o Hi·ªÉm - Luy·ªán T·∫≠p</title>
  <link rel="stylesheet" href="../../public/css/exam.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
  <!-- Loading Screen -->
  <div class="loading-screen" id="loadingScreen">
    <div class="loading-spinner">
      <i class="fas fa-spinner fa-spin"></i>
      <p>ƒêang t·∫£i ƒë·ªÅ luy·ªán t·∫≠p...</p>
    </div>
  </div>

  <!-- Exam Selection Screen -->
  <div class="exam-selection" id="examSelection">
    <div class="container">
      <div class="header">
        <div class="header-content">
          <h1><i class="fas fa-dumbbell"></i> Ch·ªçn ƒê·ªÅ Luy·ªán T·∫≠p</h1>
          <p class="header-subtitle">√în t·∫≠p ki·∫øn th·ª©c v·ªõi c√°c ƒë·ªÅ thi th·ª≠ - Kh√¥ng gi·ªõi h·∫°n s·ªë l·∫ßn l√†m b√†i</p>
        </div>
        <div class="practice-benefits">
          <div class="benefits-grid">
            <div class="benefit-item">
              <div class="benefit-icon">
                <i class="fas fa-redo"></i>
              </div>
              <div class="benefit-text">
                <span class="benefit-title">L√†m l·∫°i nhi·ªÅu l·∫ßn</span>
                <span class="benefit-desc">Kh√¥ng gi·ªõi h·∫°n s·ªë l∆∞·ª£t</span>
              </div>
            </div>
            <div class="benefit-item">
              <div class="benefit-icon">
                <i class="fas fa-pause"></i>
              </div>
              <div class="benefit-text">
                <span class="benefit-title">T·∫°m d·ª´ng ƒë∆∞·ª£c</span>
                <span class="benefit-desc">Ngh·ªâ gi·∫£i lao tho·∫£i m√°i</span>
              </div>
            </div>
            <div class="benefit-item">
              <div class="benefit-icon">
                <i class="fas fa-eye"></i>
              </div>
              <div class="benefit-text">
                <span class="benefit-title">Xem ƒë√°p √°n ngay</span>
                <span class="benefit-desc">H·ªçc h·ªèi t·ª´ sai l·∫ßm</span>
              </div>
            </div>
            <div class="benefit-item">
              <div class="benefit-icon">
                <i class="fas fa-chart-line"></i>
              </div>
              <div class="benefit-text">
                <span class="benefit-title">Ph√¢n t√≠ch chi ti·∫øt</span>
                <span class="benefit-desc">Hi·ªÉu r√µ ƒëi·ªÉm m·∫°nh/y·∫øu</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="exam-list" id="examList">
        <!-- Exams will be populated here -->
      </div>
      
      <div class="back-btn-container">
        <button onclick="window.location.href='home.html'" class="btn-back">
          <i class="fas fa-arrow-left"></i> Quay l·∫°i trang ch·ªß
        </button>
        <button onclick="debugAPIs()" class="btn-debug" style="margin-left: 1rem;">
          <i class="fas fa-bug"></i> Debug API
        </button>
        <button onclick="testPaths()" class="btn-debug" style="margin-left: 1rem; background: #e67e22;">
          <i class="fas fa-route"></i> Test Paths
        </button>
      </div>
    </div>
  </div>

  <!-- Exam Progress Bar -->
  <div class="exam-progress" id="examProgress" style="display: none;">
    <div class="timer" id="timer">00:00:00</div>
    <div class="progress-bar">
      <div class="progress-fill" id="progressBar"></div>
    </div>
    <div class="question-counter" id="questionCounter">0/0</div>
    <div class="exam-actions">
      <button class="btn-pause" id="pauseBtn" title="T·∫°m d·ª´ng">
        <i class="fas fa-pause"></i>
      </button>
      <button class="btn-submit" id="earlySubmitBtn" title="N·ªôp b√†i s·ªõm">
        <i class="fas fa-check"></i> N·ªôp b√†i
      </button>
    </div>
  </div>

  <!-- Exam Container -->
  <div class="exam-container" id="examContainer" style="display: none;">
    <div class="exam-header">
      <h1 class="exam-title" id="examTitle">B√†i Luy·ªán T·∫≠p</h1>
      <div class="exam-info">
        <div class="info-item">
          <div class="info-label">Th·ªùi gian</div>
          <div class="info-value" id="timeLimit">45 ph√∫t</div>
        </div>
        <div class="info-item">
          <div class="info-label">S·ªë c√¢u h·ªèi</div>
          <div class="info-value" id="totalQuestions">0</div>
        </div>
        <div class="info-item">
          <div class="info-label">ƒêi·ªÉm ƒë·∫°t</div>
          <div class="info-value" id="passingScore">80%</div>
        </div>
      </div>
    </div>

    <form id="examForm">
      <div id="questionsContainer"></div>
      
      <div class="submit-container">
        <button type="button" class="btn-secondary" id="reviewBtn">
          <i class="fas fa-eye"></i> Xem l·∫°i
        </button>
        <button type="submit" class="submit-btn">
          <i class="fas fa-paper-plane"></i> N·ªôp B√†i
        </button>
      </div>
    </form>
  </div>

  <!-- Review Modal -->
  <div class="modal" id="reviewModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3><i class="fas fa-list-check"></i> Xem l·∫°i b√†i l√†m</h3>
        <button class="modal-close" id="closeReviewModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="review-summary" id="reviewSummary"></div>
        <div class="review-questions" id="reviewQuestions"></div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" id="closeReview">ƒê√≥ng</button>
        <button class="submit-btn" id="submitFromReview">N·ªôp b√†i</button>
      </div>
    </div>
  </div>

  <!-- Results Modal -->
  <div class="results-modal" id="resultsModal">
    <div class="modal-content">
      <div class="results-header">
        <h2><i class="fas fa-trophy"></i> K·∫øt Qu·∫£ Luy·ªán T·∫≠p</h2>
        <div class="results-score" id="finalScore">0%</div>
      </div>
      <div class="results-details" id="resultsDetails">
        <!-- Results will be populated here -->
      </div>
      <div class="detailed-results" id="detailedResults">
        <!-- Detailed answers will be shown here -->
      </div>
      <div class="submit-container">
        <button onclick="startNewExam()" class="btn-secondary">
          <i class="fas fa-redo"></i> L√†m l·∫°i
        </button>
        <button onclick="window.location.href='home.html'" class="submit-btn">
          <i class="fas fa-home"></i> V·ªÅ trang ch·ªß
        </button>
      </div>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div class="modal" id="confirmModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3><i class="fas fa-question-circle"></i> X√°c nh·∫≠n</h3>
      </div>
      <div class="modal-body">
        <p id="confirmMessage">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën n·ªôp b√†i?</p>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" id="cancelConfirm">H·ªßy</button>
        <button class="btn-danger" id="proceedConfirm">X√°c nh·∫≠n</button>
      </div>
    </div>
  </div>

  <script src="../../public/js/auth.js"></script>
  <script>
    // Ensure the page is always visible regardless of auth.js
    document.body.style.display = 'block';
    
    // Override the auth.js handleAuthState to prevent conflicts
    window.addEventListener('load', function() {
      // Make sure the page is visible
      document.body.style.display = 'block';
    });
  </script>
  <script>
    let examData = null;
    let timeLeft = 0;
    let timerInterval = null;
    let startTime = null;
    let isPaused = false;
    let selectedExamId = null;

    // Check authentication on page load
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Page loaded, checking authentication...');
      
      // Wait a bit for auth.js to finish its initialization
      setTimeout(() => {
        const token = localStorage.getItem('userToken');
        
        if (!token) {
          console.error('No token found, redirecting to login');
          window.location.href = '/project/public/login.html';
          return;
        }
        
        console.log('Token found, loading exams...');
        loadAvailableExams();
      }, 100); // Small delay to let auth.js complete
    });

    // Load available practice exams
    async function loadAvailableExams() {
      try {
        showLoading();
        console.log('Starting to load practice exams...');
        
        const token = localStorage.getItem('userToken');
        console.log('Token found:', token ? 'Yes' : 'No');
        
        if (!token) {
          console.error('No token found, redirecting to login');
          window.location.href = '/project/public/login.html';
          return;
        }
        
        // Try multiple endpoints in sequence
        let response;
        let data;
        
        try {
          console.log('Trying main practice API...');
          response = await fetch('http://localhost:3000/api/practice/available', {
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            }
          });
          
          console.log('Practice API response status:', response.status);
          
          if (response.ok) {
            data = await response.json();
            console.log('Practice API success, data:', data);
          } else {
            console.log('Practice API failed, trying fallback...');
            throw new Error(`Practice API failed with status: ${response.status}`);
          }
        } catch (apiError) {
          console.log('Main API failed, trying simple API...', apiError.message);
          
          try {
            response = await fetch('http://localhost:3000/api/exams/simple', {
              headers: {
                'Content-Type': 'application/json'
              }
            });
            
            console.log('Simple API response status:', response.status);
            
            if (response.ok) {
              data = await response.json();
              console.log('Simple API success, data:', data);
            } else {
              throw new Error(`Simple API failed with status: ${response.status}`);
            }
          } catch (simpleError) {
            console.log('Simple API also failed, trying exam API fallback...', simpleError.message);
            
            // Last resort - try old exam API
            try {
              response = await fetch('http://localhost:3000/api/exams/practice/simple', {
                headers: {
                  'Content-Type': 'application/json'
                }
              });
              
              console.log('Exam API fallback response status:', response.status);
              
              if (response.ok) {
                data = await response.json();
                console.log('Exam API fallback success, data:', data);
              } else {
                throw new Error(`All APIs failed. Last attempt status: ${response.status}`);
              }
            } catch (examError) {
              console.error('All API attempts failed:', examError);
              throw new Error('Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi m·∫°ng v√† th·ª≠ l·∫°i.');
            }
          }
        }

        if (data && data.exams) {
          console.log('Displaying', data.exams.length, 'exams');
          displayExamList(data.exams);
        } else {
          console.warn('No exams data received:', data);
          displayExamList([]);
        }
        
        hideLoading();
      } catch (error) {
        console.error('Error loading practice exams:', error);
        hideLoading();
        
        // Don't redirect on API errors, just show error state
        const examList = document.getElementById('examList');
        examList.innerHTML = `
          <div class="error-state">
            <i class="fas fa-exclamation-triangle"></i>
            <h3>Kh√¥ng th·ªÉ t·∫£i ƒë·ªÅ luy·ªán t·∫≠p</h3>
            <p>${error.message}</p>
            <div class="error-actions">
              <button onclick="loadAvailableExams()" class="btn-retry">
                <i class="fas fa-redo"></i> Th·ª≠ l·∫°i
              </button>
              <button onclick="debugAPIs()" class="btn-debug" style="margin-left: 10px;">
                <i class="fas fa-bug"></i> Ki·ªÉm tra API
              </button>
            </div>
          </div>
        `;
        
        // Show error notification but don't redirect
        showError('C√≥ l·ªói khi t·∫£i danh s√°ch ƒë·ªÅ luy·ªán t·∫≠p: ' + error.message);
      }
    }

    // Display exam list
    function displayExamList(exams) {
      const examList = document.getElementById('examList');
      
      if (exams.length === 0) {
        examList.innerHTML = `
          <div class="no-exams">
            <i class="fas fa-inbox"></i>
            <h3>Kh√¥ng c√≥ ƒë·ªÅ luy·ªán t·∫≠p n√†o</h3>
            <p>Hi·ªán t·∫°i ch∆∞a c√≥ ƒë·ªÅ luy·ªán t·∫≠p n√†o kh·∫£ d·ª•ng.</p>
          </div>
        `;
        return;
      }

      examList.innerHTML = exams.map(exam => `
        <div class="exam-card" onclick="selectExam(${exam.id})">
          <div class="exam-card-header">
            <h3>${exam.title}</h3>
            <div class="exam-stats">
              <span class="stat-item">
                <i class="fas fa-clock"></i> ${exam.time_limit} ph√∫t
              </span>
              <span class="stat-item">
                <i class="fas fa-question-circle"></i> ${exam.actual_question_count || exam.question_count} c√¢u
              </span>
            </div>
          </div>
          <div class="exam-card-body">
            <p>${exam.description || 'Kh√¥ng c√≥ m√¥ t·∫£'}</p>
            <div class="exam-progress-info">
              <div class="progress-item">
                <span class="label">S·ªë l·∫ßn th·ª≠:</span>
                <span class="value">${exam.attempt_count}</span>
              </div>
              <div class="progress-item">
                <span class="label">ƒêi·ªÉm cao nh·∫•t:</span>
                <span class="value ${exam.best_score >= 70 ? 'passed' : 'failed'}">
                  ${exam.best_score}%
                </span>
              </div>
              ${exam.last_attempt ? `
                <div class="progress-item">
                  <span class="label">L·∫ßn cu·ªëi:</span>
                  <span class="value">${new Date(exam.last_attempt).toLocaleDateString('vi-VN')}</span>
                </div>
              ` : ''}
            </div>
          </div>
          <div class="exam-card-footer">
            <button class="btn-practice">
              <i class="fas fa-play"></i> B·∫Øt ƒë·∫ßu luy·ªán t·∫≠p
            </button>
          </div>
        </div>
      `).join('');
    }

    // Select and start exam
    async function selectExam(practiceId) {
      selectedExamId = practiceId;
      try {
        showLoading();
        const token = localStorage.getItem('userToken');
        const response = await fetch('http://localhost:3000/api/exams/practice/start', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ examId: practiceId })
        });

        if (!response.ok) {
          throw new Error('Kh√¥ng th·ªÉ b·∫Øt ƒë·∫ßu b√†i luy·ªán t·∫≠p');
        }

        const data = await response.json();
        examData = data;
        startExam();
        hideLoading();
      } catch (error) {
        console.error('Error starting practice:', error);
        showError('C√≥ l·ªói khi b·∫Øt ƒë·∫ßu b√†i luy·ªán t·∫≠p: ' + error.message);
        hideLoading();
      }
    }

    // Start exam
    function startExam() {
      document.getElementById('examSelection').style.display = 'none';
      document.getElementById('examProgress').style.display = 'flex';
      document.getElementById('examContainer').style.display = 'block';

      // Update exam info - using practice data structure
      document.getElementById('examTitle').textContent = examData.practice.title;
      document.getElementById('timeLimit').textContent = `${examData.practice.time_limit} ph√∫t`;
      document.getElementById('totalQuestions').textContent = examData.questions.length;
      document.getElementById('passingScore').textContent = `70%`; // Default passing score for practice

      // Generate questions
      generateQuestions();

      // Start timer
      startTime = new Date();
      startTimer(examData.practice.time_limit);

      // Add event listeners
      setupEventListeners();
    }

    // Generate questions HTML
    function generateQuestions() {
      const container = document.getElementById('questionsContainer');
      container.innerHTML = examData.questions.map((question, index) => 
        generateQuestionHTML(question, index)
      ).join('');

      updateProgress();
    }

    // Generate single question HTML
    function generateQuestionHTML(question, index) {
      return `
        <div class="question-container" data-question-id="${question.id}">
          <div class="question-header">
            <span class="question-number">C√¢u ${index + 1}</span>
            <span class="question-type">${getQuestionTypeText(question.question_type)}</span>
          </div>
          <div class="question-text">
            ${question.question_text}
          </div>
          <div class="options-container">
            ${generateOptionsHTML(question, index)}
          </div>
        </div>
      `;
    }

    // Generate options HTML
    function generateOptionsHTML(question, index) {
      if (question.question_type === 'multiple_choice' && question.options) {
        return question.options.map((option, i) => `
          <div class="option-item">
            <input type="radio" name="question${question.id}" value="${option}" id="q${question.id}opt${i}">
            <label for="q${question.id}opt${i}">${option}</label>
          </div>
        `).join('');
      } else if (question.question_type === 'true_false') {
        return `
          <div class="option-item">
            <input type="radio" name="question${question.id}" value="true" id="q${question.id}true">
            <label for="q${question.id}true">ƒê√∫ng</label>
          </div>
          <div class="option-item">
            <input type="radio" name="question${question.id}" value="false" id="q${question.id}false">
            <label for="q${question.id}false">Sai</label>
          </div>
        `;
      }
      return '';
    }

    // Get question type text
    function getQuestionTypeText(type) {
      switch(type) {
        case 'multiple_choice': return 'Tr·∫Øc nghi·ªám';
        case 'true_false': return 'ƒê√∫ng/Sai';
        default: return 'Kh√°c';
      }
    }

    // Setup event listeners
    function setupEventListeners() {
      // Progress tracking
      document.querySelectorAll('input[type="radio"]').forEach(input => {
        input.addEventListener('change', updateProgress);
      });

      // Form submission
      document.getElementById('examForm').addEventListener('submit', handleSubmit);

      // Review button
      document.getElementById('reviewBtn').addEventListener('click', showReview);

      // Early submit
      document.getElementById('earlySubmitBtn').addEventListener('click', function() {
        showConfirmation('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën n·ªôp b√†i s·ªõm?', submitExam);
      });

      // Pause button
      document.getElementById('pauseBtn').addEventListener('click', togglePause);

      // Modal events
      setupModalEvents();
    }

    // Setup modal events
    function setupModalEvents() {
      // Review modal
      document.getElementById('closeReviewModal').addEventListener('click', closeReview);
      document.getElementById('closeReview').addEventListener('click', closeReview);
      document.getElementById('submitFromReview').addEventListener('click', function() {
        closeReview();
        showConfirmation('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën n·ªôp b√†i?', submitExam);
      });

      // Confirmation modal
      document.getElementById('cancelConfirm').addEventListener('click', closeConfirmation);
      document.getElementById('proceedConfirm').addEventListener('click', function() {
        closeConfirmation();
        if (window.confirmCallback) {
          window.confirmCallback();
        }
      });
    }

    // Format time display
    function formatTime(seconds) {
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      const s = seconds % 60;
      return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
    }

    // Start timer
    function startTimer(duration) {
      timeLeft = duration * 60;
      updateTimerDisplay();
      
      timerInterval = setInterval(() => {
        if (!isPaused) {
          timeLeft--;
          updateTimerDisplay();
          
          if (timeLeft <= 0) {
            clearInterval(timerInterval);
            autoSubmit();
          }
        }
      }, 1000);
    }

    // Update timer display
    function updateTimerDisplay() {
      const timerElement = document.getElementById('timer');
      timerElement.textContent = formatTime(timeLeft);
      
      // Change color when time is running low
      if (timeLeft < 300) { // 5 minutes
        timerElement.classList.add('warning');
      }
      if (timeLeft < 60) { // 1 minute
        timerElement.classList.add('danger');
      }
    }

    // Toggle pause
    function togglePause() {
      isPaused = !isPaused;
      const pauseBtn = document.getElementById('pauseBtn');
      
      if (isPaused) {
        pauseBtn.innerHTML = '<i class="fas fa-play"></i>';
        pauseBtn.title = 'Ti·∫øp t·ª•c';
        showInfo('B√†i thi ƒë√£ ƒë∆∞·ª£c t·∫°m d·ª´ng');
      } else {
        pauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
        pauseBtn.title = 'T·∫°m d·ª´ng';
        showInfo('B√†i thi ƒë√£ ƒë∆∞·ª£c ti·∫øp t·ª•c');
      }
    }

    // Update progress
    function updateProgress() {
      const total = examData.questions.length;
      const answered = document.querySelectorAll('input[type="radio"]:checked').length;
      const percentage = (answered / total) * 100;
      
      document.getElementById('progressBar').style.width = `${percentage}%`;
      document.getElementById('questionCounter').textContent = `${answered}/${total}`;
    }

    // Handle form submission
    function handleSubmit(event) {
      event.preventDefault();
      showConfirmation('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën n·ªôp b√†i?', submitExam);
    }

    // Auto submit when time runs out
    function autoSubmit() {
      showInfo('H·∫øt gi·ªù! B√†i thi s·∫Ω ƒë∆∞·ª£c n·ªôp t·ª± ƒë·ªông.', 'warning');
      setTimeout(submitExam, 2000);
    }

    // Submit exam
    async function submitExam() {
      try {
        clearInterval(timerInterval);
        showLoading();

        const formData = new FormData(document.getElementById('examForm'));
        const answers = {};
        
        // Collect answers
        examData.questions.forEach(question => {
          const answer = formData.get(`question${question.id}`);
          answers[question.id] = answer;
        });

        const timeSpent = Math.floor((new Date() - startTime) / 1000);

        const token = localStorage.getItem('userToken');
        const response = await fetch('http://localhost:3000/api/exams/practice/submit', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            examId: selectedExamId,
            answers: answers,
            timeSpent: timeSpent
          })
        });

        if (!response.ok) {
          throw new Error('Kh√¥ng th·ªÉ n·ªôp b√†i luy·ªán t·∫≠p');
        }

        const result = await response.json();
        showResults(result);
        hideLoading();
      } catch (error) {
        console.error('Error submitting practice:', error);
        showError('C√≥ l·ªói khi n·ªôp b√†i: ' + error.message);
        hideLoading();
      }
    }

    // Show results
    function showResults(data) {
      const { result, detailedAnswers, summary } = data;
      
      // Hide exam interface
      document.getElementById('examProgress').style.display = 'none';
      document.getElementById('examContainer').style.display = 'none';
      
      // Show results
      const modal = document.getElementById('resultsModal');
      const scoreElement = document.getElementById('finalScore');
      
      scoreElement.textContent = summary.scorePercentage;
      scoreElement.style.color = result.score >= 70 ? '#2ecc71' : '#e74c3c'; // Using 70% as default passing score
      
      // Results details
      document.getElementById('resultsDetails').innerHTML = `
        <div class="result-grid">
          <div class="result-item">
            <div class="result-label">ƒêi·ªÉm s·ªë</div>
            <div class="result-value">${summary.scorePercentage}</div>
          </div>
          <div class="result-item">
            <div class="result-label">C√¢u ƒë√∫ng</div>
            <div class="result-value">${result.correctAnswers}/${result.totalQuestions}</div>
          </div>
          <div class="result-item">
            <div class="result-label">Th·ªùi gian</div>
            <div class="result-value">${summary.timeSpent}</div>
          </div>
          <div class="result-item">
            <div class="result-label">K·∫øt qu·∫£</div>
            <div class="result-value ${result.score >= 70 ? 'passed' : 'failed'}">
              ${result.score >= 70 ? 'T·ªët' : 'C·∫ßn c·∫£i thi·ªán'}
            </div>
          </div>
        </div>
        
        <div class="performance-analysis">
          <h4><i class="fas fa-chart-bar"></i> Ph√¢n t√≠ch k·∫øt qu·∫£</h4>
          <div class="analysis-content">
            ${generatePerformanceAnalysis(result)}
          </div>
        </div>
      `;
      
      // Detailed answers
      if (detailedAnswers && detailedAnswers.length > 0) {
        document.getElementById('detailedResults').innerHTML = `
          <div class="detailed-answers">
            <h4><i class="fas fa-list-alt"></i> Chi ti·∫øt t·ª´ng c√¢u h·ªèi</h4>
            <div class="answers-list">
              ${detailedAnswers.map((answer, index) => generateAnswerHTML(answer, index)).join('')}
            </div>
          </div>
        `;
      }
      
      modal.style.display = 'block';
    }

    // Generate performance analysis
    function generatePerformanceAnalysis(result) {
      let analysis = '';
      
      if (result.score >= 70) {
        analysis += '<div class="analysis-item success"><i class="fas fa-check-circle"></i> Ch√∫c m·ª´ng! B·∫°n ƒë√£ ƒë·∫°t k·∫øt qu·∫£ t·ªët trong b√†i luy·ªán t·∫≠p.</div>';
      } else {
        analysis += '<div class="analysis-item warning"><i class="fas fa-exclamation-triangle"></i> B·∫°n c·∫ßn √¥n t·∫≠p th√™m ƒë·ªÉ c·∫£i thi·ªán k·∫øt qu·∫£.</div>';
      }
      
      const accuracy = (result.correctAnswers / result.totalQuestions) * 100;
      if (accuracy >= 80) {
        analysis += '<div class="analysis-item info"><i class="fas fa-star"></i> ƒê·ªô ch√≠nh x√°c cao, b·∫°n ƒë√£ n·∫Øm v·ªØng ki·∫øn th·ª©c.</div>';
      } else if (accuracy >= 60) {
        analysis += '<div class="analysis-item info"><i class="fas fa-chart-line"></i> ƒê·ªô ch√≠nh x√°c kh√° t·ªët, ti·∫øp t·ª•c c·ªë g·∫Øng.</div>';
      } else {
        analysis += '<div class="analysis-item warning"><i class="fas fa-book"></i> C·∫ßn √¥n t·∫≠p th√™m ƒë·ªÉ c·∫£i thi·ªán ƒë·ªô ch√≠nh x√°c.</div>';
      }
      
      if (result.duration && examData.practice && result.duration < (examData.practice.time_limit * 60 * 0.5)) {
        analysis += '<div class="analysis-item info"><i class="fas fa-clock"></i> B·∫°n ho√†n th√†nh kh√° nhanh, h√£y ch·∫Øc ch·∫Øn ƒë√£ ƒë·ªçc k·ªπ c√¢u h·ªèi.</div>';
      }
      
      analysis += '<div class="analysis-item info"><i class="fas fa-redo"></i> ƒê√¢y l√† b√†i luy·ªán t·∫≠p, b·∫°n c√≥ th·ªÉ l√†m l·∫°i nhi·ªÅu l·∫ßn ƒë·ªÉ c·∫£i thi·ªán k·∫øt qu·∫£.</div>';
      
      return analysis;
    }

    // Generate detailed answer HTML
    function generateAnswerHTML(answer, index) {
      const isCorrect = answer.is_correct;
      const statusClass = isCorrect ? 'correct' : 'incorrect';
      const statusIcon = isCorrect ? 'fa-check-circle' : 'fa-times-circle';
      
      return `
        <div class="answer-item ${statusClass}">
          <div class="answer-header">
            <span class="question-num">C√¢u ${index + 1}</span>
            <span class="answer-status">
              <i class="fas ${statusIcon}"></i>
              ${isCorrect ? 'ƒê√∫ng' : 'Sai'}
            </span>
          </div>
          <div class="answer-content">
            <div class="question-text">${answer.question_text}</div>
            <div class="answer-details">
              <div class="user-answer">
                <strong>B·∫°n ch·ªçn:</strong> 
                <span class="answer-value ${isCorrect ? 'correct' : 'incorrect'}">
                  ${answer.user_answer || 'Kh√¥ng tr·∫£ l·ªùi'}
                </span>
              </div>
              ${!isCorrect ? `
                <div class="correct-answer">
                  <strong>ƒê√°p √°n ƒë√∫ng:</strong> 
                  <span class="answer-value correct">${answer.correct_answer}</span>
                </div>
              ` : ''}
            </div>
          </div>
        </div>
      `;
    }

    // Show review modal
    function showReview() {
      const modal = document.getElementById('reviewModal');
      const formData = new FormData(document.getElementById('examForm'));
      
      // Generate summary
      const answered = document.querySelectorAll('input[type="radio"]:checked').length;
      const total = examData.questions.length;
      
      document.getElementById('reviewSummary').innerHTML = `
        <div class="review-stats">
          <div class="stat-item">
            <span class="label">ƒê√£ tr·∫£ l·ªùi:</span>
            <span class="value">${answered}/${total}</span>
          </div>
          <div class="stat-item">
            <span class="label">C√≤n l·∫°i:</span>
            <span class="value">${total - answered}</span>
          </div>
          <div class="stat-item">
            <span class="label">Th·ªùi gian c√≤n l·∫°i:</span>
            <span class="value">${formatTime(timeLeft)}</span>
          </div>
        </div>
      `;
      
      // Generate question review
      const reviewQuestions = examData.questions.map((question, index) => {
        const userAnswer = formData.get(`question${question.id}`);
        const isAnswered = !!userAnswer;
        
        return `
          <div class="review-question ${isAnswered ? 'answered' : 'unanswered'}" 
               onclick="scrollToQuestion(${question.id})">
            <div class="review-question-header">
              <span class="question-num">C√¢u ${index + 1}</span>
              <span class="status ${isAnswered ? 'answered' : 'unanswered'}">
                <i class="fas ${isAnswered ? 'fa-check' : 'fa-question'}"></i>
                ${isAnswered ? 'ƒê√£ tr·∫£ l·ªùi' : 'Ch∆∞a tr·∫£ l·ªùi'}
              </span>
            </div>
            <div class="review-question-text">${question.question_text.substring(0, 100)}...</div>
            ${isAnswered ? `<div class="user-answer">ƒê√°p √°n: ${userAnswer}</div>` : ''}
          </div>
        `;
      }).join('');
      
      document.getElementById('reviewQuestions').innerHTML = reviewQuestions;
      modal.style.display = 'block';
    }

    // Close review modal
    function closeReview() {
      document.getElementById('reviewModal').style.display = 'none';
    }

    // Scroll to specific question
    function scrollToQuestion(questionId) {
      closeReview();
      const questionElement = document.querySelector(`[data-question-id="${questionId}"]`);
      if (questionElement) {
        questionElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
        questionElement.classList.add('highlight');
        setTimeout(() => questionElement.classList.remove('highlight'), 2000);
      }
    }

    // Show confirmation modal
    function showConfirmation(message, callback) {
      document.getElementById('confirmMessage').textContent = message;
      document.getElementById('confirmModal').style.display = 'block';
      window.confirmCallback = callback;
    }

    // Close confirmation modal
    function closeConfirmation() {
      document.getElementById('confirmModal').style.display = 'none';
      window.confirmCallback = null;
    }

    // Start new exam
    function startNewExam() {
      document.getElementById('resultsModal').style.display = 'none';
      document.getElementById('examSelection').style.display = 'block';
      
      // Reset variables
      examData = null;
      timeLeft = 0;
      startTime = null;
      isPaused = false;
      selectedExamId = null;
      
      if (timerInterval) {
        clearInterval(timerInterval);
      }
      
      // Reload available exams
      loadAvailableExams();
    }

    // Utility functions
    function showLoading() {
      document.getElementById('loadingScreen').style.display = 'flex';
    }

    function hideLoading() {
      document.getElementById('loadingScreen').style.display = 'none';
    }

    function showError(message) {
      // Create a more user-friendly error display instead of alert
      const toast = document.createElement('div');
      toast.className = 'toast toast-error';
      toast.innerHTML = `
        <i class="fas fa-exclamation-circle"></i>
        <span>L·ªói: ${message}</span>
        <button onclick="this.parentElement.remove()" class="toast-close">
          <i class="fas fa-times"></i>
        </button>
      `;
      
      // Add styles if not already present
      if (!document.getElementById('toast-styles')) {
        const style = document.createElement('style');
        style.id = 'toast-styles';
        style.textContent = `
          .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #e74c3c;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 400px;
            animation: slideIn 0.3s ease;
          }
          .toast-error { background: #e74c3c; }
          .toast-success { background: #2ecc71; }
          .toast-warning { background: #f39c12; }
          .toast-info { background: #3498db; }
          .toast-close {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            margin-left: auto;
            padding: 5px;
          }
          @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
          }
          .error-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
          }
          .btn-retry, .btn-debug {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
          }
          .btn-retry {
            background: #3498db;
            color: white;
          }
          .btn-debug {
            background: #95a5a6;
            color: white;
          }
          .btn-retry:hover { background: #2980b9; }
          .btn-debug:hover { background: #7f8c8d; }
        `;
        document.head.appendChild(style);
      }
      
      document.body.appendChild(toast);
      
      // Auto remove after 5 seconds
      setTimeout(() => {
        if (toast.parentElement) {
          toast.remove();
        }
      }, 5000);
    }

    function showInfo(message, type = 'info') {
      // Create a toast notification
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.innerHTML = `
        <i class="fas fa-info-circle"></i>
        <span>${message}</span>
      `;
      
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.classList.add('show');
      }, 100);
      
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => document.body.removeChild(toast), 300);
      }, 3000);
    }

    // Prevent accidental page refresh
    window.addEventListener('beforeunload', function(e) {
      if (examData && timeLeft > 0) {
        const message = 'B·∫°n ƒëang trong qu√° tr√¨nh l√†m b√†i. R·ªùi kh·ªèi trang s·∫Ω m·∫•t ti·∫øn tr√¨nh hi·ªán t·∫°i.';
        e.returnValue = message;
        return message;
      }
    });

    function debugAPIs() {
      console.log('=== DEBUG API ENDPOINTS ===');
      showInfo('ƒêang ki·ªÉm tra k·∫øt n·ªëi API...', 'info');
      
      const token = localStorage.getItem('userToken');
      console.log('Token exists:', !!token);
      
      // Test endpoints one by one
      const endpoints = [
        { url: '/api/practice/test', method: 'GET', name: 'Practice Test' },
        { url: '/api/practice/simple', method: 'GET', name: 'Practice Simple' },
        { url: '/api/practice/available', method: 'GET', name: 'Practice Available', auth: true },
        { url: '/api/exams/debug/all', method: 'GET', name: 'Exams Debug' }
      ];
      
      let completedTests = 0;
      const results = [];
      
      endpoints.forEach(async (endpoint, index) => {
        try {
          console.log(`Testing ${endpoint.name}...`);
          
          const headers = { 'Content-Type': 'application/json' };
          if (endpoint.auth && token) {
            headers['Authorization'] = `Bearer ${token}`;
          }
          
          const response = await fetch(endpoint.url, {
            method: endpoint.method,
            headers: headers
          });
          
          const result = {
            name: endpoint.name,
            url: endpoint.url,
            status: response.status,
            ok: response.ok,
            data: null,
            error: null
          };
          
          if (response.ok) {
            try {
              result.data = await response.json();
              console.log(`‚úÖ ${endpoint.name}: Success`, result.data);
            } catch (jsonError) {
              result.error = 'Invalid JSON response';
              console.log(`‚ö†Ô∏è ${endpoint.name}: JSON Parse Error`, jsonError);
            }
          } else {
            result.error = `HTTP ${response.status} ${response.statusText}`;
            console.log(`‚ùå ${endpoint.name}: Failed`, result.error);
          }
          
          results.push(result);
          completedTests++;
          
          if (completedTests === endpoints.length) {
            displayDebugResults(results);
          }
          
        } catch (fetchError) {
          console.error(`‚ùå ${endpoint.name}: Network Error`, fetchError);
          results.push({
            name: endpoint.name,
            url: endpoint.url,
            status: 0,
            ok: false,
            data: null,
            error: fetchError.message
          });
          
          completedTests++;
          if (completedTests === endpoints.length) {
            displayDebugResults(results);
          }
        }
      });
    }
    
    function displayDebugResults(results) {
      console.log('=== DEBUG RESULTS ===', results);
      
      const examList = document.getElementById('examList');
      examList.innerHTML = `
        <div class="debug-results">
          <h3><i class="fas fa-bug"></i> K·∫øt qu·∫£ ki·ªÉm tra API</h3>
          <div class="debug-grid">
            ${results.map(result => `
              <div class="debug-item ${result.ok ? 'success' : 'error'}">
                <div class="debug-header">
                  <strong>${result.name}</strong>
                  <span class="status ${result.ok ? 'ok' : 'error'}">
                    ${result.ok ? '‚úÖ' : '‚ùå'} ${result.status}
                  </span>
                </div>
                <div class="debug-url">${result.url}</div>
                ${result.error ? `<div class="debug-error">‚ùå ${result.error}</div>` : ''}
                ${result.data ? `
                  <div class="debug-data">
                    <details>
                      <summary>üìä Response Data</summary>
                      <pre>${JSON.stringify(result.data, null, 2)}</pre>
                    </details>
                  </div>
                ` : ''}
              </div>
            `).join('')}
          </div>
          <div class="debug-actions">
            <button onclick="loadAvailableExams()" class="btn-primary">
              <i class="fas fa-redo"></i> Th·ª≠ l·∫°i t·∫£i d·ªØ li·ªáu
            </button>
            <button onclick="createSampleData()" class="btn-secondary">
              <i class="fas fa-plus"></i> T·∫°o d·ªØ li·ªáu m·∫´u
            </button>
          </div>
        </div>
      `;
      
      const successCount = results.filter(r => r.ok).length;
      const message = `Ki·ªÉm tra ho√†n t·∫•t: ${successCount}/${results.length} API ho·∫°t ƒë·ªông`;
      showInfo(message, successCount === results.length ? 'success' : 'warning');
    }
    
    async function createSampleData() {
      try {
        showInfo('ƒêang t·∫°o d·ªØ li·ªáu m·∫´u...', 'info');
        
        const response = await fetch('/api/practice/seed', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          showInfo('T·∫°o d·ªØ li·ªáu m·∫´u th√†nh c√¥ng!', 'success');
          console.log('Sample data created:', data);
          setTimeout(() => loadAvailableExams(), 1000);
        } else {
          const error = await response.text();
          showInfo('L·ªói khi t·∫°o d·ªØ li·ªáu m·∫´u: ' + error, 'error');
        }
      } catch (error) {
        console.error('Error creating sample data:', error);
        showInfo('L·ªói k·∫øt n·ªëi khi t·∫°o d·ªØ li·ªáu m·∫´u', 'error');
      }
    }

    // Test path function
    function testPaths() {
      console.log('=== PATH TESTING ===');
      console.log('Current URL:', window.location.href);
      console.log('Current pathname:', window.location.pathname);
      console.log('Current origin:', window.location.origin);
      
      const paths = [
        '/project/public/login.html',
        '../../public/login.html',
        '../../../public/login.html',
        '/project/src/users/home.html',
        'home.html'
      ];
      
      console.log('Testing paths:');
      paths.forEach(path => {
        console.log(`- ${path} -> ${new URL(path, window.location.href).href}`);
      });
      
      // Test token
      const token = localStorage.getItem('userToken');
      console.log('Token exists:', !!token);
      if (token) {
        console.log('Token preview:', token.substring(0, 20) + '...');
      }
      
      // Test localStorage
      console.log('All localStorage keys:', Object.keys(localStorage));
      
      showInfo('Path test completed - check console for details', 'info');
    }
  </script>
</body>
</html>
